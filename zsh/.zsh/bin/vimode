#!/usr/bin/env zsh

setopt localoptions err_return

function send-notification() {
  notify-send 'vimode' "$1"
}

function mode() {
  [[ "$(xkb-switch -p)" == "us(vim$1)" ]] && return 0
  return 1
}

function normal() {
  mode 'normal' && return 0
  # xkb-switch -s 'us(vimnormal)'
  setxkbmap -layout 'us' -variant 'vimnormal'
  xbindkeys -fg ~/.xbindkeysrc.vimnormal.scm
  send-notification 'normal'
}

function insert() {
  mode 'insert' && return 0
  # xkb-switch -s 'us(viminsert)'
  setxkbmap -layout 'us' -variant 'viminsert'
  xbindkeys -fg ~/.xbindkeysrc.vimnormal.scm
  xbindkeys
  send-notification 'insert'
}

if [[ $# -gt 1 ]]; then
  echo 'Usage: vimode [mode]'
  return 1
elif [[ $# -eq 0 ]]; then
  xkb-switch -p
else
  killall xbindkeys 2>&1 > /dev/null || true
  $1
fi
