# vim: ft=tmux sw=4 ts=4 sts=4 et tw=80 fdl=0 fdm=marker nospell:

unbind-key -a
source-file ~/.tmux/.tmux-default-keybindings.conf                              # Reset tmux keys to default $(tmux -f /dev/null -L temp start-server \; list-keys)
# Plugins {{{1
    # List of plugins, supports `github_username/repo` or full git URLs
    # 'tpm' must be the first one.
    set -g @tpm_plugins "                   \
        tmux-plugins/tpm                    \
        tmux-plugins/tmux-battery           \
        tmux-plugins/tmux-continuum         \
        tmux-plugins/tmux-copycat           \
        tmux-plugins/tmux-logging           \
        tmux-plugins/tmux-online-status     \
        tmux-plugins/tmux-open              \
        tmux-plugins/tmux-resurrect         \
        tmux-plugins/tmux-sensible          \
        tmux-plugins/tmux-urlview           \
        tmux-plugins/tmux-yank              \
        "
    # Other plugins not installed, source: https://github.com/tmux-plugins
    # git@bitbucket.com/user/plugin         \
    # seebi/tmux-colors-solarized           \
    set-option -g @resurrect-processes 'ssh "git log" grunt-wrapper tail'
    set-option -g @yank_selection 'primary'
    set-option -g @continuum-restore 'on'
    set-option -g @urlview-key 'u'
    run-shell ~/.tmux/plugins/tpm/tpm                                           # initializes TMUX plugin manager
# }}}
# Options {{{1
    # Server options
    set-option -sg default-terminal "screen-256color-bce"                       # HOME and END key will have different keycode if this is not set
    set-option -sg escape-time 1
    set-option -sg exit-unattached off                                          # Exit the server if there is no attached client
    set-option -sg focus-events on
    set-option -sg set-clipboard on
    set-option -sg terminal-overrides 'screen*:XT:smcup@:rmcup@'                # Allow terminal to use its own scrolling, 'XT' is important here

    # Session options
    set-option -g base-index 1                                                  # start windows numbering at 1
    if-shell 'which -s reattach-to-user-namespace' \
        'set-option -g default-command "reattach-to-user-namespace \
            -l /usr/bin/env zsh"' \
        'set-option -g default-command "/usr/bin/env zsh"'
    # set-option -g default-shell '/usr/bin/zsh'
    set-option -g destroy-unattached off
    set-option -g detach-on-destroy on
    set-option -g display-panes-time 1000                                       # slightly longer pane indicators display time
    set-option -g mouse on                                                      # Allow selecting pane with mouse
    set-option -g prefix C-a
    set-option -g renumber-windows on                                           # renumber windows when a window is closed
    set-option -g repeat-time 0
    set-option -g set-titles on                                                 # set terminal title
    set-option -g set-titles-string '#S - #W - #{pane_current_command}'         # format for setting terminal title
    set-option -g status-keys vi                                                # Force vi-style key bindings
    set-option -ga update-environment \
        ' SSH_OS SSH_CLIENT SSH_CONNECTIONS SSH_AUTH_SOCK SSH_AGENT_PID'        # Inherit the additional env variables, in addition to the defaults (note -a)
    set-option -g visual-activity on

    # Window options
    set-option -wg aggressive-resize on                                         # Resize pane when connected from different resolution
    set-option -wg automatic-rename off                                         # don't rename window to reflect current program
    set-option -wg clock-mode-style 24                                          # 24 hour clock
    set-option -wg mode-keys vi                                                 # Use vi style key bindings
    set-option -wg monitor-activity on
    set-option -wg pane-base-index 1                                            # make pane numbering consistent with windows
    set-option -wg wrap-search on
    set-option -wg xterm-keys on
# }}}
if-shell '[[ $(pgrep -f powerline-daemon >/dev/null 2>&1) -eq 1 ]]' \
    run-shell 'powerline-daemon -q'
# Key bindings {{{1
    # General {{{2
        unbind-key C-b                                                          # GNU-Screen compatible prefix
        bind-key C-a send-prefix
        bind-key -n C-g send-prefix                                             # Used to send prefix to nested tmux sessions
        bind-key e new-window -n '~/.tmux.conf' \
            '${EDITOR:-vim} ~/.tmux.conf && tmux source ~/.tmux.conf && \
                tmux display "~/.tmux.conf sourced"'
        bind-key r source-file ~/.tmux.conf \; display '~/.tmux.conf sourced'
        bind-key n command-prompt 'rename-session %%'
        bind-key i command-prompt -p 'Insert window at:' \
            'new-window -a -t %1; swap-window -t -1'
        bind-key m command-prompt -p 'Move this window to:' 'swap-window -t %1'
        bind-key c new-window -c "#{pane_current_path}"
        bind-key < swap-window -t :-1                                           # swap current pane with the previous one
        bind-key > swap-window -t :+1                                           # swap current pane with the next one
        bind-key C-w resize-pane -Z
        bind-key C-o show-options -g
    # }}}
    # Navigation {{{2
        bind-key - split-window -v -c "#{pane_current_path}"                    # split current window horizontally
        bind-key \ split-window -h -c "#{pane_current_path}"                    # split current window vertically
        # Smart pane switching with awareness of vim splits
        # bind-key -n -r C-h run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' && tmux send-keys C-h) || (([[ $(tmux list-panes | wc -l) -eq 1 ]] && tmux previous-window) || tmux select-pane -L)"
        # bind-key -n -r C-l run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' && tmux send-keys C-l) || (([[ $(tmux list-panes | wc -l) -eq 1 ]] && tmux next-window) || tmux select-pane -R)"
        bind-key -n -r C-h run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' && \
            tmux send-keys C-h) || tmux select-pane -L"
        bind-key -n -r C-j run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' && \
            tmux send-keys C-j) || tmux select-pane -D"
        bind-key -n -r C-k run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' && \
            tmux send-keys C-k) || tmux select-pane -U"
        bind-key -n -r C-l run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' && \
            tmux send-keys C-l) || tmux select-pane -R"
        bind-key -r h select-pane -L
        bind-key -r j select-pane -D
        bind-key -r k select-pane -U
        bind-key -r l select-pane -R
        bind-key -n M-l next-window
        bind-key -n M-h previous-window
        # bind-key -n M-Right select-window -t :.+
        # bind-key -n M-Left select-window -t :.-
        # bind-key BTab select-pane -t :.-
        # bind-key -n -r M-1 select-window -t :1

        bind-key -n -r M-1 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-1) || tmux select-window -t :1"
        bind-key -n -r M-2 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-2) || tmux select-window -t :2"
        bind-key -n -r M-3 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-3) || tmux select-window -t :3"
        bind-key -n -r M-4 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-4) || tmux select-window -t :4"
        bind-key -n -r M-5 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-5) || tmux select-window -t :5"
        bind-key -n -r M-6 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-6) || tmux select-window -t :6"
        bind-key -n -r M-7 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-7) || tmux select-window -t :7"
        bind-key -n -r M-8 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-8) || tmux select-window -t :8"
        bind-key -n -r M-9 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-9) || tmux select-window -t :9"
    # }}}
    # Copy Mode {{{2
        bind-key -t vi-copy C-d page-down
        bind-key -t vi-copy C-u page-up
        bind-key -t vi-copy Escape cancel
        bind-key -t vi-copy v begin-selection
        bind-key -t vi-copy y copy-pipe \
            "tmux save-buffer - | xclipper -selection clipboard -i"
        bind-key -t vi-copy Y copy-pipe \
            "save2tmp --cb='tmux set-buffer'; \
            tmux show-buffer | xclipper -selection clipboard -i"
        bind-key Enter copy-mode                                                # enter copy mode
        bind-key P choose-buffer                                                # choose which buffer to paste from
        bind-key b list-buffers                                                 # list paster buffers
        bind-key p paste-buffer                                                 # paste from the top paste buffer
        bind-key / list-keys -t vi-copy
    # }}}
    source-file ~/.tmux/.tmux-statusline-colors.conf
    # source-file $BREWHOME/lib/python2.7/site-packages/powerline/bindings/tmux/powerline.conf
    # source-file $BREWHOME/lib/python2.7/site-packages/powerline/bindings/tmux/powerline_tmux_1.9_plus.conf
# }}}
# if-shell '[[ $(tmux list-sessions | wc -l ) -eq 0 ]]' \
    # 'run-shell $HOME/.tmux/plugins/tmux-resurrect/scripts/restore.sh'
