# vim: ft=tmux sw=4 ts=4 sts=4 et tw=80 fdl=0 fdm=marker nospell:

# if-shell alias: if
# run-shell alias: run
# bind-key alias: bind
# unbind-key alias: unbind
# set-option alias: set

unbind -a
source-file ~/.tmux/.tmux-default-keybindings.conf                              # Reset tmux keys to default $(tmux -f /dev/null -L temp start-server \; list-keys)
# Plugins {{{1
    # Install tpm if it is not installed yet.
    if '! test -d ~/.tmux/plugins/tpm' \
        'run "git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm"'
    # List of plugins, supports `github_username/repo` or full git URLs
    # 'tpm' must be the first one.
    set -g @tpm_plugins "                   \
        tmux-plugins/tpm                    \
        tmux-plugins/tmux-battery           \
        tmux-plugins/tmux-continuum         \
        tmux-plugins/tmux-copycat           \
        tmux-plugins/tmux-logging           \
        tmux-plugins/tmux-online-status     \
        tmux-plugins/tmux-open              \
        tmux-plugins/tmux-prefix-highlight  \
        tmux-plugins/tmux-resurrect         \
        tmux-plugins/tmux-sensible          \
        tmux-plugins/tmux-test              \
        nhdaly/tmux-better-mouse-mode       \
        "
    # Other plugins not installed, source: https://github.com/tmux-plugins
        # tmux-plugins/tmux-yank              \
        # tmux-plugins/tmux-net-speed         \
        # tmux-plugins/tmux-urlview           \
    # git@bitbucket.com/user/plugin         \
    # seebi/tmux-colors-solarized           \
    set -g @resurrect-processes 'ssh "git log" grunt-wrapper tail'
    set -g @yank_selection 'primary'
    set -g @continuum-restore 'on'
    # set -g @urlview-key 'u'
    set -g @prefix_highlight_fg 'colour22'                               # default is 'colour231'
    set -g @prefix_highlight_bg 'colour148'                              # default is 'colour04'
    set -g @prefix_highlight_show_copy_mode 'on'
    run ~/.tmux/plugins/tpm/tpm                                          # initializes TMUX plugin manager
# }}}
# Options {{{1
    # Server options
    set -sg default-terminal "xterm-256color"                            # HOME and END key will have different keycode if this is not set
    set -sg escape-time 1
    set -sg exit-unattached off                                          # Exit the server if there is no attached client
    set -sg focus-events on
    set -sg set-clipboard on
    set -sg terminal-overrides 'screen*:XT:smcup@:rmcup@'                # Allow terminal to use its own scrolling, 'XT' is important here

    # Session options
    set -g base-index 1                                                  # start windows numbering at 1
    if 'which -s reattach-to-user-namespace' \
        'set -g default-command "reattach-to-user-namespace \
            -l /usr/bin/env zsh"' \
        'set -g default-command "/usr/bin/env zsh"'
    # set -g default-shell '/usr/bin/zsh'
    set -g destroy-unattached off
    set -g detach-on-destroy on
    set -g display-panes-time 1000                                       # slightly longer pane indicators display time
    # When this is on, somehow mouse cannot be used in konsole
    # set -g mouse on                                                      # Allow using mouse
    set -g prefix C-a
    set -g renumber-windows on                                           # renumber windows when a window is closed
    set -g repeat-time 0
    set -g set-titles on                                                 # set terminal title
    set -g set-titles-string '#S - #W - #{pane_current_command}'         # format for setting terminal title
    set -g status-keys vi                                                # Force vi-style key bindings
    set -ga update-environment \
        ' SSH_OS SSH_CLIENT SSH_CONNECTION SSH_AUTH_SOCK SSH_AGENT_PID'        # Inherit the additional env variables, in addition to the defaults (note -a)
    set -g visual-activity on

    # Window options
    set -wg aggressive-resize on                                         # Resize pane when connected from different resolution
    set -wg automatic-rename off                                         # don't rename window to reflect current program
    set -wg clock-mode-style 24                                          # 24 hour clock
    set -wg mode-keys vi                                                 # Use vi style key bindings
    set -wg monitor-activity on
    set -wg pane-base-index 1                                            # make pane numbering consistent with windows
    set -wg wrap-search on
    set -wg xterm-keys on
# }}}
# Key bindings {{{1
    # General {{{2
        unbind C-b                                                          # GNU-Screen compatible prefix
        bind C-a send-prefix
        # bind -n C-g send-prefix                                             # Used to send prefix to nested tmux sessions
        bind e new-window -n '~/.tmux.conf' \
            '${EDITOR:-vim} ~/.tmux.conf && tmux source ~/.tmux.conf && \
                tmux display "~/.tmux.conf sourced"'
        bind r source-file ~/.tmux.conf \; display '~/.tmux.conf sourced'
        bind n command-prompt 'rename-session %%'
        bind i command-prompt -p 'Insert window at:' \
            'new-window -a -t %1; swap-window -t -1'
        bind m command-prompt -p 'Move this window to:' 'swap-window -t %1'
        bind c new-window -c "#{pane_current_path}"
        bind < swap-window -t :-1                                           # swap current pane with the previous one
        bind > swap-window -t :+1                                           # swap current pane with the next one
        bind C-w resize-pane -Z
        bind C-o show-options -g
    # }}}
    # Navigation {{{2
        bind - split-window -v -c "#{pane_current_path}"                    # split current window horizontally
        bind \ split-window -h -c "#{pane_current_path}"                    # split current window vertically
        # Smart pane switching with awareness of vim splits
        # bind -n -r C-h run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' && tmux send-keys C-h) || (([[ $(tmux list-panes | wc -l) -eq 1 ]] && tmux previous-window) || tmux select-pane -L)"
        # bind -n -r C-l run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' && tmux send-keys C-l) || (([[ $(tmux list-panes | wc -l) -eq 1 ]] && tmux next-window) || tmux select-pane -R)"
        bind -n -r C-h run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' && \
            tmux send-keys C-h) || tmux select-pane -L"
        bind -n -r C-j run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' && \
            tmux send-keys C-j) || tmux select-pane -D"
        bind -n -r C-k run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' && \
            tmux send-keys C-k) || tmux select-pane -U"
        bind -n -r C-l run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' && \
            tmux send-keys C-l) || tmux select-pane -R"
        bind -r h select-pane -L
        bind -r j select-pane -D
        bind -r k select-pane -U
        bind -r l select-pane -R
        bind -n M-l next-window
        bind -n M-h previous-window
        # bind -n M-Right select-window -t :.+
        # bind -n M-Left select-window -t :.-
        # bind BTab select-pane -t :.-
        # bind -n -r M-1 select-window -t :1

        bind -n -r M-1 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-1) || tmux select-window -t :1"
        bind -n -r M-2 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-2) || tmux select-window -t :2"
        bind -n -r M-3 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-3) || tmux select-window -t :3"
        bind -n -r M-4 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-4) || tmux select-window -t :4"
        bind -n -r M-5 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-5) || tmux select-window -t :5"
        bind -n -r M-6 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-6) || tmux select-window -t :6"
        bind -n -r M-7 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-7) || tmux select-window -t :7"
        bind -n -r M-8 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-8) || tmux select-window -t :8"
        bind -n -r M-9 run "(tmux display-message -p \
            '#{pane_current_command}' | \
            grep -iqE '(^|\/)g?(view|n?vim?)(diff)?$' \
            && tmux send-keys M-9) || tmux select-window -t :9"

        # make scrolling with wheels work
        # bind -n WheelUpPane if -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'select-pane -t=; copy-mode -e; send-keys -M'"
        # bind -n WheelDownPane select-pane -t= \; send-keys -M
    # }}}
    # Copy Mode {{{2
        bind -T copy-mode-vi C-d send-keys -X page-down
        bind -T copy-mode-vi C-u send-keys -X page-up
        bind -T copy-mode-vi Escape send-keys -X cancel
        bind -T copy-mode-vi v send-keys -X begin-selection
        # bind -T copy-mode-vi y send-keys -X copy-pipe \
            # "tmux save-buffer - | xclipper -selection clipboard -i"
        # bind -T copy-mode-vi Y send-keys -X copy-pipe \
            # "save2tmp --cb='tmux set-buffer'; \
            # tmux show-buffer | xclipper -selection clipboard -i"

        # transfer copied text to attached terminal with yank:
        # https://github.com/sunaku/home/blob/master/bin/yank
        bind -T copy-mode-vi y send-keys -X copy-pipe 'yank > #{pane_tty}'

        # transfer copied text to attached terminal with yank:
        # https://github.com/sunaku/home/blob/master/bin/yank
        bind -n M-y run 'tmux save-buffer - | yank > #{pane_tty}'

        # transfer previously copied text (chosen from a menu) to attached terminal:
        # https://github.com/sunaku/home/blob/master/bin/yank
        bind -n M-Y choose-buffer 'run "tmux save-buffer -b \"%%\" - | yank > #{pane_tty}"'

        bind Enter copy-mode                                                # enter copy mode
        bind P choose-buffer                                                # choose which buffer to paste from
        bind b list-buffers                                                 # list paster buffers
        bind p paste-buffer                                                 # paste from the top paste buffer
        bind -T copy-mode-vi / list-keys
    # }}}
    source-file ~/.tmux/.tmux-statusline-colors.conf
    # source-file $BREWHOME/lib/python2.7/site-packages/powerline/bindings/tmux/powerline.conf
    # source-file $BREWHOME/lib/python2.7/site-packages/powerline/bindings/tmux/powerline_tmux_1.9_plus.conf
# }}}
# if 'tmux list-sessions | wc -l' \
    # 'run $HOME/.tmux/plugins/tmux-resurrect/scripts/restore.sh'
if 'pgrep -f powerline-daemon >/dev/null 2>&1' '' \
    'run "powerline-daemon -q"'
run ~/.tmux/plugins/tmux-better-mouse-mode/scroll_copy_mode.tmux
run ~/.tmux/plugins/tmux-prefix-highlight/prefix_highlight.tmux
# run ~/.tmux/plugins/tmux-net-speed/net_speed.tmux
